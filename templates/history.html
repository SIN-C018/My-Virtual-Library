{% extends "base.html" %}
{% block title %}Borrow History{% endblock %}

{% block content %}
<h2 class="mb-4 text-primary fw-bold">Full Borrow History</h2>

<form class="mb-4" method="GET">
    <div class="input-group w-75 w-md-50">
        <input type="text" name="q" class="form-control border-dark" 
               placeholder="Search by Book, Name or ERP ID..." 
               value="{{ request.args.get('q', '') }}" autofocus>
        <button class="btn btn-primary " type="submit">Search</button>
        {% if request.args.get('q') %}
            <a href="{{ url_for('history') }}" class="btn btn-outline-secondary ms-2">Clear</a>
        {% endif %}
    </div>
</form>

{% if borrows %}
<div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
        <thead class="table-dark">
          <tr>
    <th class="border-end border-dark">No.</th>
    <th class="border-end">Book Title</th>
    <th class="border-end">Student Name</th>
    <th class="border-end">ERP ID</th>
    <th class="border-end">Issue Date</th>
    <th class="border-end">Returned On</th>
    <th class="border-end">Status</th>
    <th class="border-end">Action</th>
    <th>Delete</th>
</tr>

        </thead>
        <tbody>
            {% for b in borrows %}
            <tr class="{{ 'table-danger' if b.is_overdue else '' }}">
                <td>{{ loop.index }}</td>
                <td><strong>{{ b.book_title }}</strong></td>
                <td>{{ b.student_name }}</td>
                <td><strong>{{ b.erp_id }}</strong></td>
                <td>{{ b.borrow_date.strftime('%d %b %Y') }}</td>
                <td>
                    {% if b.return_date %}
                        {{ b.return_date.strftime('%d %b %Y') }}
                    {% else %}
                        <span class="text-danger fw-bold">Not Returned</span>
                    {% endif %}
                </td>
                <td>
                    {% if b.return_date %}
                        <span class="badge bg-success">Returned</span>
                    {% elif b.is_overdue %}
                        <span class="badge bg-danger">Overdue</span>
                    {% else %}
                        <span class="badge bg-warning text-dark">Active</span>
                    {% endif %}
                </td>
                <td>
                    {% if not b.return_date %}
                        <a href="{{ url_for('return_book', borrow_id=b.id) }}" class="btn btn-success btn-sm">Return</a>
                    {% else %}
                        <span class="text-success fw-bold">Returned</span>
                    {% endif %}
                </td>
                <td>
                    <a href="{{ url_for('delete_record', borrow_id=b.id) }}"
                       class="btn btn-danger btn-sm"
                       onclick="return confirm('Permanently delete this record?\n{{ b.book_title }} - {{ b.student_name }}')">
                        Delete
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="text-center py-5">
    <h4 class="text-muted">
        {% if request.args.get('q') %}
            No records found
        {% else %}
            No borrow records yet.
        {% endif %}
    </h4>
</div>
{% endif %}
{% endblock %}